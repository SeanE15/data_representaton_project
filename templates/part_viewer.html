<html>
    <head>
        <title>View Parts</title>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    </head>
    <body>
        <div class="container">
            <h1 class="text-center">Irish AutoBiz</h1>
            <!-- Code taken from: https://getbootstrap.com/docs/5.3/components/carousel/ -->
            <!-- Creating a carousel of images for the different console types; Images will bring to console official home-pages if clicked -->
            <div id="my_carousel" class="carousel slide carousel-fade" data-ride="carousel">
                <div class="carousel-inner">
                    <!-- Set timer to 5 seconds per slide (5000 milliseconds); images shown are in the images folder and relative paths are shown in code -->
                    <!-- The dimensions of the images are also all adjusted to be the same to avoid any clipping on the page between rotations of the carousel -->
                    <div class="carousel-item active" data-bs-interval="5000">
                        <a href="https://www.micksgarage.com/home?gad_source=1&gclid=EAIaIQobChMI4dK267vwggMVVotQBh1TLQnWEAAYASAAEgKRb_D_BwE">
                            <img src="../images/micks-garage-logo.jpg" class="d-block w-100" alt="micksGarage" style="width: 500px; height: 550px">
                        </a>
                    </div>
                    <div class="carousel-item" data-bs-interval="5000">
                        <a href="https://www.auto-doc.ie/?utm_medium=cpc&utm_source=google&tb_prm=20750135270&gshp=1&gad_source=1&gclid=EAIaIQobChMIttqb9rvwggMVGNTtCh3SEAf0EAAYASAAEgLFM_D_BwE">
                            <img src="../images/autodoc_logo.jpg" class="d-block w-100" alt="auto-doc" style="width: 500px; height: 550px">
                        </a>
                    </div>
                    <div class="carousel-item" data-bs-interval="5000">
                        <a href="https://www.irishautoparts.ie/">
                            <img src="../images/irish_parts.jpg" class="d-block w-100" alt="irishParts" style="width: 500px; height: 550px">
                        </a>
                    </div>
                </div>
        <div>
            <h1 class="text-center">Parts Catalogue</h1>
            <h3 class="text-center">Help us create Ireland's most extensive parts catalogue!</h3>
            <p> You can help us to become Ireland's first community driven parts catalogue by using your indepth knowledge of parts. Established in 2023 - Irish AutoBiz is a community driven project looking to create an extensive list of parts using OEM numbers and manufacturer pricing.
                Help us reach our goal of 500 parts before 2024 and every contributer will be entered into a draw to win a fabulous prize!
            </p>
            <table class="table" id="partTable">
                <tr>
                        <th>id</th>
                        <th>Part Name</th>
                        <th>
                            Part Number
                        </th>
                        <th>Price</th>
                </tr>
                
            </table>
        </div>
        <div>
            <h2 class="text-center">Penalty Point Counter</h2>
            <label for="countyInput">County:</label>
            <input type="text" id="countyInput" name="countyInput">
            <label for="yearInput">Year:</label>
            <input type="text" id="yearInput" name="yearInput">
            <button onclick="searchPenaltyPoints()">Search</button>
        
            <table class="table" id="pointsTable">
                <tr>
                    <th>id</th>
                    <th>Penalty Points List</th>
                </tr>
            </table>
        </div>
        <div> <button id="showCreateButton" onclick="showCreate()">Create</button></div>
        <div id='createUpdateForm' style="display: none">
                <h2><span id="createLabel">Create a</span> <span id="updateLabel">update</span> Part</h2>
                <input type="hidden" name="id"/>
                Part Name <input type="text" name="Part_Name" /><br/>
                Part Number <input type="text" name="Part_No"/> <br/>
                Price <input type="number" name="Price"/> <br/>
                <span><button id="doCreateButton" onclick="doCreate()">Create</button></span>
                <span><button id="doUpdateButton" onclick="doUpdate()">Update</button></span>
        </div>
    </body>
    <script>

    function showCreate(){
        document.getElementById('showCreateButton').style.display="none"
        document.getElementById('partTable').style.display="none"
        document.getElementById('createUpdateForm').style.display="block"

        document.getElementById('createLabel').style.display="inline"
        document.getElementById('updateLabel').style.display="none"

        document.getElementById('doCreateButton').style.display="block"
        document.getElementById('doUpdateButton').style.display="none"

    }


    function showViewAll(){
        document.getElementById('showCreateButton').style.display="block"
        document.getElementById('partTable').style.display="block"
        document.getElementById('createUpdateForm').style.display="none"
    }

    function showUpdate(buttonElement){
        document.getElementById('showCreateButton').style.display="none"
        document.getElementById('partTable').style.display="none"
        document.getElementById('createUpdateForm').style.display="block"

        document.getElementById('createLabel').style.display="none"
        document.getElementById('updateLabel').style.display="inline"

        document.getElementById('doCreateButton').style.display="none"
        document.getElementById('doUpdateButton').style.display="block"

        // Clear the form before populating it
        clearForm();

        var rowElement = buttonElement.parentNode.parentNode
        
        var part = getPartFromRow(rowElement)
        populateFormWithPart(part)
    }


    function doCreate(){
        var form = document.getElementById('createUpdateForm')

        var part = {
            Part_Name: form.querySelector('input[name="Part_Name"]').value,
            Part_No: form.querySelector('input[name="Part_No"]').value,
            Price: form.querySelector('input[name="Price"]').value,
        };

        console.log(JSON.stringify(part))
        createPartAjax(part)
        
    }

    function doUpdate(){
        var part = getPartFromForm();
        var rowElement = document.getElementById(part.id);
        updatePartAjax(part);
        setPartInRow(rowElement, part);
       
        clearForm();
        showViewAll();
    }

    function doDelete(r){
        var tableElement = document.getElementById('partTable');
        var rowElement = r.parentNode.parentNode;
        var index = rowElement.rowIndex;
        deletePartAjax(rowElement.getAttribute("id"));
        tableElement.deleteRow(index);

    }

    function addPartToTable(part) {
    var tableElement = document.getElementById('partTable');
    var rowElement = tableElement.insertRow(-1);
    rowElement.setAttribute('id', part.id);
    var cell1 = rowElement.insertCell(0);
    cell1.innerHTML = part.id;
    var cell2 = rowElement.insertCell(1);
    cell2.innerHTML = part.Part_Name;  
    var cell3 = rowElement.insertCell(2);
    cell3.innerHTML = part.Part_No;  
    var cell4 = rowElement.insertCell(3);
    cell4.innerHTML = part.Price;  
    var cell5 = rowElement.insertCell(4);
    cell5.innerHTML = '<button onclick="showUpdate(this)">Update</button>';
    var cell6 = rowElement.insertCell(5);
    cell6.innerHTML = '<button onclick="doDelete(this)">Delete</button>';
    }


    function clearForm(){
        var form = document.getElementById('createUpdateForm')

        form.querySelector('input[name="Part_Name"]').value=''
        form.querySelector('input[name="Part_No"]').value=''
        form.querySelector('input[name="Price"]').value=''
    }

    function getPartFromRow(rowElement){
        var part ={}
        part.id  = rowElement.getAttribute('id')
        part.name = rowElement.cells[1].firstChild.textContent
        part.number = rowElement.cells[2].firstChild.textContent
        part.price = parseInt(rowElement.cells[3].firstChild.textContent,10)
        return part
    }

    function setPartInRow(rowElement, part){
        rowElement.cells[0].firstChild.textContent= part.id  
        rowElement.cells[1].firstChild.textContent= part.name
        rowElement.cells[2].firstChild.textContent= part.number
        rowElement.cells[3].firstChild.textContent= part.price
    }

    function populateFormWithPart(part){
        var form = document.getElementById('createUpdateForm')
        form.querySelector('input[name="id"]').disabled = true
        form.querySelector('input[name="id"]').value  = part.id
        form.querySelector('input[name="Part_Name"]').value= part.name
        form.querySelector('input[name="Part_No"]').value= part.number
        form.querySelector('input[name="Price"]').value= part.price
        return part
    }

    function getPartFromForm(){
        var form = document.getElementById('createUpdateForm')
        var part = {

        id : form.querySelector('input[name="id"]').value,
        name : form.querySelector('input[name="Part_Name"]').value,
        number : form.querySelector('input[name="Part_No"]').value,
        price : parseInt(form.querySelector('input[name="Price"]').value,10)

        }
        console.log(JSON.stringify(part))
        return part
    }

    function searchPenaltyPoints() {
        var county = document.getElementById('countyInput').value;
        var year = document.getElementById('yearInput').value;
        getPenaltyPointsByCountyAndYear(county, year);
    }

    function updatePenaltyPointsTable(point) {
        var tableElement = document.getElementById('pointsTable');

        // Clear existing rows from the table
        while (tableElement.rows.length > 1) {
            tableElement.deleteRow(1);
        }

        // Loop through the data and add rows to the table
        for (var county in data['Drivers cumulative penalty points']['2022']) {
            var rowElement = tableElement.insertRow(-1);
            rowElement.setAttribute('id', county);

            // Column 1: County Name
            var cell1 = rowElement.insertCell(0);
            cell1.innerHTML = county;

            // Column 2: Total penalty points
            var cell2 = rowElement.insertCell(1);
            cell2.innerHTML = data['Drivers cumulative penalty points']['2022'][county]['Total penalty points'];

            // Column 3 to Column N: Individual penalty points
            for (var i = 1; i <= 12; i++) {
                var cell = rowElement.insertCell(i + 1);
                cell.innerHTML = data['Drivers cumulative penalty points']['2022'][county][i + ' penalty point'];
            }
        }
    }

    function getAllAjax(){
        $.ajax({
            "url": "/parts/",
            "method":"GET",
            "data":"",
            "dataType": "JSON",
            "success":function(result){
                //console.log(result);
                for (part of result){
                    addPartToTable(part);
                }
                
            },
            "error":function(xhr,status,error){
                console.log("error: "+status+" msg:"+error);
            }
        });

    }

    function createPartAjax(part){
    console.log(JSON.stringify(part));
    $.ajax({
        "url": "/parts/",
        "method":"POST",
        "data": JSON.stringify({
            "Part_Name": part.Part_Name, 
            "Part_No": part.Part_No,
            "Price": part.Price 
        }),
        "dataType": "JSON",
        contentType: "application/json; charset=utf-8",
        "success": function(result){
            part.id = result.id
            addPartToTable(part)
            clearForm()
            showViewAll()
        },
        "error": function(xhr, status, error){
            console.log("error: "+status+" msg:"+error);
        }
    });


    }

    function updatePartAjax(part){
        //var car = {"reg":"12 D 1234","price":8000}
        console.log(JSON.stringify(part));
        $.ajax({
            "url": "/parts/"+encodeURI(part.id),
            "method":"PUT",
            "data": JSON.stringify({
            "Part_Name": part.Part_Name,
            "Part_No": part.Part_No,
            "Price": part.Price
            }),
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "success":function(result){
               // console.log(result);
                  
            },
            "error":function(xhr,status,error){
                console.log("error: "+status+" msg:"+error);
            }
        });
    }

    function deletePartAjax(id){
        
        //console.log(JSON.stringify('deleting '+id));
        $.ajax({
            "url": "/parts/"+encodeURI(id),
            "method":"DELETE",
            "data":"",
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "success":function(result){
                //console.log(result);
                  
            },
            "error":function(xhr,status,error){
                console.log("error: "+status+" msg:"+error);
            }
        });
    }

    function getPenaltyPointsByCountyAndYear(county, year) {
        // Perform an AJAX request to retrieve penalty points by county and year
        // Update the pointsTable with the results
        $.ajax({
            "url": "/points/", 
            "method": "GET",
            "data": { "county": county, "year": year },
            "dataType": "JSON",
            "success": function (result) {
                // Update the pointsTable with the retrieved data
                updatePenaltyPointsTable(result);
            },
            "error": function (xhr, status, error) {
                console.log("error: " + status + " msg:" + error);
            }
        });
    }
    getAllAjax();
  
    
    </script>
</html>